{% extends 'base.html' %}
{% block title %}Empresas{% endblock %}
{% block content %}
{#
  Tela de gestão de empresas
  - Lado esquerdo: formulário de criação/edição
  - Lado direito: listagem de empresas com status e ações
#}
<div class="row">
  <div class="col-md-5">
    <div class="card mb-4">
      <div class="card-header"><strong>{% if editar_id %}Editar Empresa{% else %}Nova Empresa{% endif %}</strong></div>
      <div class="card-body">
        <form method="POST">
          <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
          <div class="mb-3">
            {{ form.nome.label(class="form-label") }}
            {{ form.nome(class="form-control", placeholder="Ex.: Minha Empresa LTDA") }}
            {% for error in form.nome.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            {{ form.cnpj.label(class="form-label") }}
            {{ form.cnpj(class="form-control", placeholder="Opcional") }}
            {% for error in form.cnpj.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </div>
          <div class="d-flex flex-column" style="gap: 8px;">
            {{ form.submit(class="btn btn-primary") }}
            {% if editar_id %}
            <div class="d-flex" style="gap: 8px;">
              <a href="{{ url_for('empresas') }}" class="btn btn-secondary flex-fill">Cancelar</a>
              <button type="submit" class="btn btn-warning flex-fill"
                      formaction="{{ url_for('deletar_empresa', empresa_id=editar_id) }}"
                      formmethod="post"
                      onclick="return confirm('Tem certeza que deseja desativar esta empresa?');">
                Desativar
              </button>
            </div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-7">
    <div class="card">
      <div class="card-header"><strong>Empresas</strong></div>
      <div class="card-body p-0">
        <table class="table mb-0">
          <thead>
            <tr>
              <th class="align-middle text-center">#</th>
              <th class="align-middle">Nome</th>
              <th class="align-middle">CNPJ</th>
              <th class="align-middle text-center">Status</th>
              <th class="align-middle text-center" style="width: 160px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for e in empresas %}
            <tr {% if editar_id == e.id %}class="table-warning"{% endif %}>
              <td class="align-middle text-center">{{ e.id }}</td>
              <td class="align-middle">{{ e.nome }}</td>
              <td class="align-middle text-center">{{ e.cnpj or '-' }}</td>
              <td class="align-middle text-center">
                {% if e.ativo %}
                  <span class="badge bg-success">Ativa</span>
                {% else %}
                  <span class="badge bg-secondary">Inativa</span>
                {% endif %}
              </td>
              <td class="align-middle">
                <div class="d-flex flex-column align-items-center" style="gap: 4px;">
                  <a class="btn btn-sm btn-primary w-100" href="{{ url_for('editar_empresa', empresa_id=e.id) }}">Editar</a>
                  {% if e.ativo %}
                  <form method="POST" action="{{ url_for('deletar_empresa', empresa_id=e.id) }}" class="w-100" onsubmit="return confirm('Desativar esta empresa?');">
                    <button type="submit" class="btn btn-sm btn-warning w-100">Desativar</button>
                  </form>
                  {% else %}
                  <form method="POST" action="{{ url_for('reativar_empresa', empresa_id=e.id) }}" class="w-100" onsubmit="return confirm('Reativar esta empresa?');">
                    <button type="submit" class="btn btn-sm btn-success w-100">Reativar</button>
                  </form>
                  {% endif %}
                  <form method="POST" action="{{ url_for('excluir_empresa_permanentemente', empresa_id=e.id) }}" class="w-100" onsubmit="return confirm('ATENÇÃO: Esta ação EXCLUIRÁ PERMANENTEMENTE a empresa e todos os seus dados. Tem certeza?');">
                    <button type="submit" class="btn btn-sm btn-danger w-100">Deletar</button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted">Nenhuma empresa cadastrada.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
</div>
{% endblock %}


