{% extends 'base.html' %}
{% block content %}
<div class="cards">
    <div class="card-indicador estoque">
        <div class="icon"><i class="bi bi-box-seam"></i></div>
        <div class="valor">{{ total_estoque }} <span class="desc">itens</span></div>
        <div class="desc">Estoque Atual</div>
    </div>
    <div class="card-indicador valor">
        <div class="icon"><i class="bi bi-currency-dollar"></i></div>
        <div class="valor">R$ {{ valor_estoque|float|round(2)|replace('.', ',') }}</div>
        <div class="desc">Valor em Estoque</div>
    </div>
    <div class="card-indicador lucro">
        <div class="icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div class="valor">R$ {{ margem_lucro|float|round(2)|replace('.', ',') }}</div>
        <div class="desc">Margem de Lucro do Mês</div>
    </div>

</div>
<div class="grafico-box">
    <div class="grafico-header">
        <span class="fw-bold">Evolução da Margem de Lucro (Últimos 6 meses)</span>
        {% if current_user.role in ['administrador','contador'] %}
        <div>
            <a href="{{ url_for('relatorio_fiscal') }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> Exportar Relatório</a>
        </div>
        {% endif %}
    </div>
    <canvas id="grafico-lucro" height="80"></canvas>
</div>
<div class="row g-4">
  <div class="col-md-6">
    <div class="grafico-box">
        <div class="grafico-header">
            <span class="fw-bold">Distribuição do Valor em Estoque (Top 5)</span>
        </div>
        <div class="d-flex justify-content-center">
            <div style="max-width: 420px; width: 100%; height: 280px;">
                <canvas id="grafico-estoque-pizza" style="max-height: 280px;"></canvas>
            </div>
        </div>
        <div class="text-muted" style="font-size: 0.9rem; margin-top:8px;">Baseado em quantidade × preço de compra.</div>
        
        <script>
        /* eslint-disable */
        /* jshint ignore:start */
        const ctxPizza = document.getElementById('grafico-estoque-pizza').getContext('2d');
        new Chart(ctxPizza, {
            type: 'doughnut',
            data: {
                labels: {{ grafico_pizza_labels|tojson }},
                datasets: [{
                    data: {{ grafico_pizza_dados|tojson }},
                    backgroundColor: [
                        '#42a5f5', '#66bb6a', '#ffa726', '#ab47bc', '#ef5350', '#8d6e63'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 12 }
                    }
                },
                cutout: '55%'
            }
        });
        /* jshint ignore:end */
        </script>
    </div>
  </div>
  <div class="col-md-6">
    <div class="grafico-box">
        <div class="grafico-header">
            <span class="fw-bold">Top 5 Produtos Vendidos no Mês (Qtd)</span>
        </div>
        <div class="d-flex justify-content-center">
            <div style="max-width: 420px; width: 100%; height: 280px;">
                <canvas id="grafico-bar-vendas" style="max-height: 280px;"></canvas>
            </div>
        </div>
        <script>
        /* eslint-disable */
        /* jshint ignore:start */
        const ctxBar = document.getElementById('grafico-bar-vendas').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: {{ grafico_bar_vendas_labels|tojson }},
                datasets: [{
                    label: 'Quantidade vendida',
                    data: {{ grafico_bar_vendas_dados|tojson }},
                    backgroundColor: '#1e88e5',
                    borderRadius: 6,
                    maxBarThickness: 28
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                }
            }
        });
        /* jshint ignore:end */
        </script>
    </div>
  </div>
</div>
<div class="table-box mb-4">
    <div class="fw-bold mb-2">Produtos com Divergência Fiscal</div>
    <table>
        <thead>
            <tr>
                <th>PRODUTO</th>
                <th>CUSTO ÚLTIMA COMPRA</th>
                <th>CUSTO MÉDIO</th>
                <th>PREÇO DE VENDA</th>
                <th>DIVERGÊNCIA</th>
                <th>AÇÃO</th>
            </tr>
        </thead>
        <tbody>
        {% for d in divergencias %}
            <tr>
                <td>{{ d.produto }}</td>
                <td>R$ {{ d.custo_ultima|float|round(2)|replace('.', ',') }}</td>
                <td>R$ {{ d.custo_medio|float|round(2)|replace('.', ',') }}</td>
                <td>R$ {{ d.preco_venda|float|round(2)|replace('.', ',') }}</td>
                <td class="divergencia">
                    <i class="bi bi-exclamation-triangle"></i>
                    {% if d.tipo == 'compra_diferente' %}
                        <br><span style="font-size:0.95em;">Diferença compra: R$ {{ d.diferenca_compra|float|round(2)|replace('.', ',') }}<br>(Penúltima: R$ {{ d.custo_penultima|float|round(2)|replace('.', ',') }})</span>
                    {% endif %}
                </td>
                <td><a href="{{ url_for('editar_produto', produto_id=d.id) }}" class="btn btn-primary btn-sm">Corrigir</a></td>
            </tr>
        {% else %}
        <tr><td colspan="6" class="text-center">Nenhuma divergência fiscal encontrada.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<div class="row g-4">
    <div class="col-md-6">
        <div class="table-box">
            <div class="fw-bold mb-2">Últimas Transações</div>
            <div class="d-flex flex-column gap-2">
                {% for mov in ultimas_transacoes %}
                <div class="d-flex justify-content-between align-items-center">
                    <span class="{% if mov.tipo == 'compra' %}text-success{% else %}text-danger{% endif %}">
                        <i class="bi bi-arrow-{% if mov.tipo == 'compra' %}down{% else %}up{% endif %}-circle"></i>
                        {{ mov.tipo|capitalize }} - {{ mov.produto.nome }}<br><small>{{ mov.data.strftime('%d/%m/%Y') }} - {{ mov.quantidade }} unidades</small>
                    </span>
                    <span class="fw-bold">
                        {% if mov.tipo == 'venda' %}+ {% endif %}R$ {{ (mov.valor_unitario * mov.quantidade)|float|round(2)|replace('.', ',') }}
                    </span>
                </div>
                {% else %}
                <div class="text-center text-muted">Nenhuma transação recente.</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="table-box">
            <div class="fw-bold mb-2">Ações Rápidas</div>
            <div class="row g-3">
                <!-- Primeira linha -->
                <div class="col-4">
                    <a href="{{ url_for('registrar_movimentacao', tipo='venda') }}" class="btn-acao btn btn-outline-primary w-100" title="Lançar uma venda" data-bs-toggle="tooltip">
                        <i class="bi bi-cart-check"></i>
                        <span class="d-none d-sm-inline">Venda</span>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{{ url_for('registrar_movimentacao', tipo='compra') }}" class="btn-acao btn btn-outline-primary w-100" title="Lançar uma compra" data-bs-toggle="tooltip">
                        <i class="bi bi-cart-plus"></i>
                        <span class="d-none d-sm-inline">Compra</span>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{{ url_for('adicionar_produto') }}" class="btn-acao btn btn-outline-primary w-100" title="Cadastrar um novo produto" data-bs-toggle="tooltip">
                        <i class="bi bi-plus-circle"></i>
                        <span class="d-none d-sm-inline">Produto</span>
                    </a>
                </div>

                <!-- Segunda linha -->
                <div class="col-4">
                    <a href="{{ url_for('listar_movimentacoes') }}" class="btn-acao btn btn-outline-primary w-100" title="Ver histórico de movimentações" data-bs-toggle="tooltip">
                        <i class="bi bi-clock-history"></i>
                        <span class="d-none d-sm-inline">Histórico</span>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{{ url_for('listar_devolucoes') }}" class="btn-acao btn btn-outline-primary w-100" title="Ver devoluções" data-bs-toggle="tooltip">
                        <i class="bi bi-arrow-return-left"></i>
                        <span class="d-none d-sm-inline">Devoluções</span>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{{ url_for('inventario') }}" class="btn-acao btn btn-outline-primary w-100" title="Analisar inventário" data-bs-toggle="tooltip">
                        <i class="bi bi-box-seam"></i>
                        <span class="d-none d-sm-inline">Inventário</span>
                    </a>
                </div>

                <!-- Terceira linha -->
                {% if current_user.role == 'administrador' %}
                <div class="col-4">
                    <a href="{{ url_for('previsao_demanda') }}" class="btn-acao btn btn-outline-primary w-100" title="Previsão de demanda" data-bs-toggle="tooltip">
                        <i class="bi bi-graph-up"></i>
                        <span class="d-none d-sm-inline">Previsão</span>
                    </a>
                </div>
                {% else %}
                <div class="col-4"></div>
                {% endif %}

                {% if current_user.role in ['administrador','contador'] %}
                <div class="col-4">
                    <a href="{{ url_for('relatorio_fiscal') }}" class="btn-acao btn btn-outline-primary w-100" title="Relatório fiscal do mês" data-bs-toggle="tooltip">
                        <i class="bi bi-file-earmark-bar-graph"></i>
                        <span class="d-none d-sm-inline">Fiscal</span>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{{ url_for('relatorio_geral_completo') }}" class="btn-acao btn btn-outline-primary w-100" title="Relatório geral completo" data-bs-toggle="tooltip">
                        <i class="bi bi-file-earmark-text"></i>
                        <span class="d-none d-sm-inline">Geral</span>
                    </a>
                </div>
                {% else %}
                <div class="col-4"></div>
                <div class="col-4"></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% if alertas|length > 0 %}
<div class="alert alert-danger d-flex justify-content-between align-items-center mt-4">
    <span><i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Alerta Crítico</strong>
        {% for a in alertas %} Produto {{ a.produto }} vendido abaixo do custo em {{ a.data }}. {% endfor %}
    </span>
    <form method="get" action="{{ url_for('listar_movimentacoes') }}" class="mb-0">
        <button type="submit" class="btn btn-danger btn-sm">Verificar</button>
    </form>
</div>
{% endif %}
<script>
/* eslint-disable */
/* jshint ignore:start */
const ctx = document.getElementById('grafico-lucro').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ grafico_labels|tojson }},
        datasets: [{
            label: 'Margem de Lucro (R$)',
            data: {{ grafico_lucro|tojson }},
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30,136,229,0.08)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#1e88e5',
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
            x: { grid: { display: false } }
        }
    }
});
/* jshint ignore:end */
</script>
{% endblock %}